<input id="project_id" value="{{project.id}}" required class="hidden" hidden/>
<div class="grid grid-cols-2 gap-5">
<!-- Dates -->
<div>
    <label for="date1" class="block text-sm text-gray-500 dark:text-gray-300">Starting date</label>

    <input type="date" id="date1" min="2019-01-01" max="2029-01-01" value="{% now 'Y-m-d' %}" required class="block  mt-2 w-full placeholder-gray-400/70 dark:placeholder-gray-500 rounded-lg border border-gray-200 bg-white px-5 py-2.5 text-gray-700 focus:border-blue-400 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-40 dark:border-gray-600 dark:bg-gray-900 dark:text-gray-300 dark:focus:border-blue-300" />
</div>
<div>
    <label for="date2" class="block text-sm font-semibold text-gray-500 dark:text-gray-300">Date to calculate</label>

    <input type="date" id="date2" min="2019-01-01" max="2029-01-01" required class="block  mt-2 w-full placeholder-gray-400/70 dark:placeholder-gray-500 rounded-lg border border-gray-200 bg-white px-5 py-2.5 text-gray-700 focus:border-blue-400 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-40 dark:border-gray-600 dark:bg-gray-900 dark:text-gray-300 dark:focus:border-blue-300" />
</div>
<!-- Prices -->
<div>
    <label for="price1" class="block text-sm text-gray-500 dark:text-gray-300">Starting price</label>

    <input type="number" id="price1" min="0" value="100" class="block  mt-2 w-full placeholder-gray-400/70 dark:placeholder-gray-500 rounded-lg border border-gray-200 bg-white px-5 py-2.5 text-gray-700 focus:border-blue-400 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-40 dark:border-gray-600 dark:bg-gray-900 dark:text-gray-300 dark:focus:border-blue-300" />
</div>

<div>
    <label for="price2" class="block text-sm text-gray-500 dark:text-gray-300">Calculated Price</label>

    <input disabled type="number" id="price2" class="block cursor-not-allowed mt-2 w-full placeholder-gray-400/70 dark:placeholder-gray-500 rounded-lg border border-gray-200 bg-white px-5 py-2.5 text-gray-700 focus:border-blue-400 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-40 dark:border-gray-600 dark:bg-gray-900 dark:text-gray-300 dark:focus:border-blue-300" />
</div>

<hr class="border-gray-200 dark:border-gray-700">
<hr class="border-gray-200 dark:border-gray-700">
<p class="text-gray-500 dark:text-gray-300">Weights:</p>
<p class="text-gray-500 dark:text-gray-300"></p>
<!-- Instruction -->
<p class="text-gray-500 dark:text-gray-300 text-sm">To calculate the final price of a project based on its products, you assign weights to each product representing its relative contribution to the total cost.</p>
<p class="text-gray-500 dark:text-gray-300 text-sm">The final price is computed as a weighted sum of the costs of the products.</p>

<!-- Weights -->
{% for product in project.products.all %}
<div>
    <label for="weight" class="block text-sm text-gray-500 dark:text-gray-300">
        {{ product.name }}
    </label>
    <input type="hidden" id="product-{{ forloop.counter }}-id" value="{{product.id}}" hidden class="hidden">
    <input type="number" id="product-{{ forloop.counter }}-weight" min="0" value="10" class="block  mt-2 w-full placeholder-gray-400/70 dark:placeholder-gray-500 rounded-lg border border-gray-200 bg-white px-5 py-2.5 text-gray-700 focus:border-blue-400 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-40 dark:border-gray-600 dark:bg-gray-900 dark:text-gray-300 dark:focus:border-blue-300" />
</div>
 {% endfor %}


</div>

<button id="calculate-button" class="mt-5 px-6 py-2 font-medium tracking-wide text-white capitalize transition-colors duration-300 transform bg-blue-600 rounded-lg hover:bg-blue-500 focus:outline-none focus:ring focus:ring-blue-300 focus:ring-opacity-80">
    <span id="button-text">Calculate</span>
    <div id="spinner" style="border-top-color:#ffffff;" class="hidden loader ease-linear rounded-full border-4 border-t-4 h-5 w-5"></div>
</button>

<p id="error-message" class="mt-3 text-xs text-red-400"></p>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const calculateButton = document.getElementById('calculate-button');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');
    
        function calculate() {
            const data = {
                project_id: document.getElementById('project_id').value || null,
                date1: document.getElementById('date1').value || null,
                price1: parseFloat(document.getElementById('price1').value) || 0,
                date2: document.getElementById('date2').value || null,
                // price2: parseFloat(document.getElementById('price2').value) || 0,

                // Placeholder for products and their weights
                products: []
            };

            // Collect all products' IDs and weights
            const productElements = document.querySelectorAll('[id^="product-"]'); // Select all elements whose id starts with "product-"
            productElements.forEach((element) => {
                // Check if the element is a weight input (e.g., id contains "-weight")
                if (element.id.includes('-weight')) {
                    const productCounter = element.id.split('-')[1]; // Extract the product counter from the id
                    const productId = document.getElementById(`product-${productCounter}-id`).value; // Get the corresponding product ID
                    const productWeight = parseFloat(element.value) || 0; // Get the weight

                    // Add the product details (id and weight) to the data object
                    data.products.push({
                        product_id: productId,
                        weight: productWeight
                    });
                }
            });

            console.log(data); // Check the data object to see all the values

            // Show the spinner and disable the button
            buttonText.classList.add('hidden');
            spinner.classList.remove('hidden');
            calculateButton.disabled = true; // Disable button to prevent multiple clicks
    
            fetch('{% url "project_calculate_view" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}', // Include CSRF token if necessary
                },
                body: JSON.stringify(data),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Update the values in the calculator based on the response

                document.getElementById('price2').value = data.price2 || '';
                document.getElementById('error-message').innerText = data.error_message || '';

                /*
                // Optional Products weights for testing
                */
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            })
            .finally(() => {
                // Restore button text and re-enable the button
                buttonText.classList.remove('hidden');
                spinner.classList.add('hidden');
                calculateButton.disabled = false;
            });
        }
    
        calculateButton.addEventListener('click', calculate);
        /*
        const inputs = document.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
            input.addEventListener('input', calculate);
        });
        */
    });
    
</script>